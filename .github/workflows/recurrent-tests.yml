nname: Recurrent tests - bot test

on:
  schedule:
    - cron: "0 */2 * * *"
    - cron: "15 */6 * * *"
    - cron: "30 */12 * * *"
  workflow_dispatch:
 

jobs:
  run_1h_tests:
    if: github.event.schedule == '0 */2 * * *'  
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        profile:
          - br-se1
          - br-ne1
        marker:
          - test: "'basic or cold_storage or presign'"
            name: "'basic or cold_storage or presign'"
        config:
          - path: "../../../params.example.yaml"
            name: "example"
    uses: ./.github/workflows/run-tests.yml
    with:
      name: "${{ matrix.marker.name }}_1hours.${{ matrix.config.name }}"
      config: ${{ matrix.config.path }}
      profile: ${{ matrix.profile }}
      flags: "--no-header -vv -n auto --tb=line --color=no -m ${{ matrix.marker.test }} --tb=line"
    secrets:
      PROFILES: ${{ secrets.PROFILES }}

  webhook_1h:
    needs: run_1h_tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Send webhook for 1h tests
        run: |
          cd /app
          ./bin/webhook.py "${{ vars.WEBHOOK_URL }}" "src/s3_specs/docs/s3-specs/artifact/" "${{ github.repository }}" "${{ github.run_id }}" "1h"

  run_6h_tests:
    if: github.event.schedule == '15 */6 * * *'
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        profile:
          - br-se1
          - br-ne1
        marker:
          - test: "'policy or bucket_versioning or acl or locking'"
            name: "'policy or bucket_versioning or acl or locking'"
        config:
          - path: "../../../params.example.yaml"
            name: "example"
    uses: ./.github/workflows/run-tests.yml
    with:
      name: "${{ matrix.marker.name }}_6hours.${{ matrix.config.name }}"
      config: ${{ matrix.config.path }}
      profile: ${{ matrix.profile }}
      flags: "--no-header -vv -n auto --tb=line --color=no -m ${{ matrix.marker.test }} --tb=line"
    secrets:
      PROFILES: ${{ secrets.PROFILES }}

  webhook_6h:
    needs: run_6h_tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Send webhook for 6h tests
        run: |
          cd /app
          ./bin/webhook.py "${{ vars.WEBHOOK_URL }}" "src/s3_specs/docs/s3-specs/artifact/" "${{ github.repository }}" "${{ github.run_id }}" "6h"

  run_12h_tests:
    if: github.event.schedule == '30 */12 * * *'  
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        profile:
          - br-se1
          - br-ne1
        marker:
          - test: "'multiple_objects or big_objects'"
            name: "'multiple_objects or big_objects'"
        config:
          - path: "../../../params.example.yaml"
            name: "example"
    uses: ./.github/workflows/run-tests.yml
    with:
      name: "${{ matrix.marker.name }}_12hours.${{ matrix.config.name }}"
      config: ${{ matrix.config.path }}
      profile: ${{ matrix.profile }}
      flags: "--no-header -vv -n auto --tb=line --color=no -m ${{ matrix.marker.test }} --tb=line"
    secrets:
      PROFILES: ${{ secrets.PROFILES }}

  webhook_12h:
    needs: run_12h_tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Send webhook for 12h tests
        run: |
          cd /app
          ./bin/webhook.py "${{ vars.WEBHOOK_URL }}" "src/s3_specs/docs/s3-specs/artifact/" "${{ github.repository }}" "${{ github.run_id }}" "12h"
